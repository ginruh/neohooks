version: '3'
services:
  redis:
    image: redis:6.2-alpine
    volumes:
      - "./conf/redis/prod/redis.conf:/usr/local/etc/redis/redis.conf"
      - redis_data:/data
    command: redis-server /usr/local/etc/redis/redis.conf
  ui:
    image: ghcr.io/iyorozuya/neohooks-ui:master
    expose:
      - 3000
    depends_on:
      - api
  api:
    image: ghcr.io/iyorozuya/neohooks-api:master
    expose:
      - 5000
    depends_on:
      - redis
  webhook:
    image: ghcr.io/iyorozuya/neohooks-webhook-service:master
    expose:
      - 5000
    depends_on:
      - redis
  nginx:
    image: nginx:1.21-alpine
    restart: unless-stopped
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./conf/nginx/prod/nginx.conf:/etc/nginx/conf.d/neohooks.site.conf
      - certbot_etc:/etc/letsencrypt
      - certbot_var:/var/lib/letsencrypt
      - web_root:/var/www/html
    depends_on:
      - api
      - ui
  certbot:
    image: certbot/certbot
    environment:
      - CERTBOT_EMAIL
    volumes:
      - certbot_etc:/etc/letsencrypt
      - certbot_var:/var/lib/letsencrypt
      - web_root:/var/www/html
    command: certonly --webroot --webroot-path=/var/www/html --email $CERTBOT_EMAIL --agree-tos --no-eff-email -d neohooks.site -d www.neohooks.site
    depends_on:
      - nginx

volumes:
  redis_data:
  certbot_etc:
  certbot_var:
  web_root:
    driver: local
